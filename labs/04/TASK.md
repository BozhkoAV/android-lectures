# Лабораторная работа №4. UI-Тесты, Рефакторинг и Исправление Ошибок.

## Цели
1. Познакомиться с принципами и получить практические навыки разработки UI тестов для Android приложений.
1. Познакомиться с инструментами IDE для поддержки рефакторинга кода

## Задачи
Предполагается, что все задачи решаются с помощью Instrumentation (Android) tests и Espresso Framework, если иное явно не указано в тексте задания.

### Задача 1. Простейший UI тест
Познакомьтесь с Espresso Framework: https://developer.android.com/training/testing/espresso. Разработайте приложение, в котором есть одна кнопка (`Button`) и одно текстовое поле (`EditText`). При (первом) нажатии на кнопку текст на кнопке должен меняться.

Напишите Espresso тест, который проверяет, что при повороте экрана содержимое текстового поля (каким бы оно ни было) сохраняется, а надпись на кнопке сбрасывается в исходное состояние. 

#### Указания
1. Для поворота экрана можно воспользоваться 
```
        activityScenario.onActivity { activity ->
            activity.setRequestedOrientation(
                ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE
            )
        }
```
(см. также https://stackoverflow.com/a/42591933

2. Очевидно, что причиной сброса состояния является не столько поворот экрана (который можно запретить в `AndroidManifest.xml`), сколько пересоздание самой Activity. Для упрощения кода вместо поворота экрана можно использовать метод `androidx.test.core.app.ActivityScenario#recreate`

2. Объясните, кто и в какой момент сохраняет состояние `EditText`. При необходимости освежите в памяти знания, усвоенные в [Лаб. №2](../02/TASK.md).

3. Исходный текст этой задачи на проверку присылать не нужно.

### Задача 2. Тестирование навигации.
Возьмите [референсную реализацию](res/reference) приложения из Лаб №3 о навигации (решение с помощью navgraph). Напишите UI тесты, проверяющие навигацию между 4мя исходными Fragments/Activity (1-2-3-About).

#### Указания
1. Должно получиться несколько тестов. Если получается один огромный тест, который проверяет сразу все, — его нужно разделить на более мелкие тесты некоторым разумным образом.
1. Проверяйте глубину backstack (например, с помощью навигации "назад" и "вверх" из разных исходных состояний)
1. Проверяйте навигацию "вперед": кнопки должны открывать соответствующие Activity/Fragment
1. Проверяйте, что при повороте экрана состояние не теряется
1. Не привязывайтесь к именам классов, кроме `MainActivity`, который является точкой входа в приложение.
1. Можно использовать следующие наблюдения:
   1. Кнопки имеют идентификаторы `@+id/bnToFirst`, `@+id/bnToSecond`, `@+id/bnToThird`.
   2. Фрагменты имеют Layout с идентификаторами `@+id/fragment1`, `@+id/fragment2`, `@+id/fragment3`
   2. Activity имеют Layout с идентификаторами `@+id/activity_main`, `@+id/activity_about`
   4. Детали реализации навигации в About Activity должны быть убраны из тестов. Можно использовать `fun openAbout()` из файла `AboutUtils.kt`. Внутри этого файла есть 3 реализации: `openAboutViaBottomNav`, `openAboutViaDrawer`, `openAboutViaOptions`, и `openAbout` перенаправляющий вызов в одну из трех реализаций. При необходимости функцию `openAbout` можно отредактировать — перенаправить вызов в другую функцию-реализацию из трех представленных выше.
   ```kotlin
   fun openAbout() = openAboutViaBottomNav()
   ```

#### Способ проверки

Данное задание будет проверяться в автоматическом режиме следующим образом: есть несколько реализаций программы: одна корректная и несколько вариантов с разными ошибками. Из присланного на проверку кода удаляются "продуктовые" исходники и заменяются на исходники соответствующего варианта тестового приложения. Предложенные тесты должны завершаться без ошибок при прогоне на корректной реализации и завершаться с ошибками при прогоне на реализациях с ошибками. В качестве ошибок выбраны наиболее интересные и распространенные ошибки прошлых лет.

Затем исходный текст будет просмотрен преподавателем на предмет неуместных заимствований и наличия неожиданных API или некорректных использований корректных API.


### Задача 3. Рефакторинг

После того, как в результате решения задачи 2 появилась "достаточно хорошая" реализация тестов, перенесите эти тесты в проект из Лаб. 3.

#### Указания

1. Выполните рефакторинг продуктового (не тестового) кода, чтобы используемые идентификаторы кнопок и layouts в продуктовом коде назывались так же, какими их ожидает тест. 
1. Для переименования идентификаторов используйте [rename refactoring](https://www.jetbrains.com/help/idea/rename-refactorings.html). При необходимости используйте и [другие типы рефакторингов](https://www.jetbrains.com/help/idea/refactoring-source-code.html)

### Задача 4. Исправление ошибок

Примените разработанные тесты к каждой из 3х задач Лаб.3 о навигации (кроме задачи с демонстрацией флага/атрибута): `startActivityForResult`, `startActivity+Intent.flags`, `navgraph`

Исправьте обнаруженные ошибки

# Общие Требования

## Отчет
Исправьте листинги в отчете к Лаб.3 так, чтобы они соответствовали актуальному состоянию кода. 

Дополните отчет информацией о том, какие ошибки были найдены в результате тестирования, в чем их природа и как они были исправлены.

Пришлите исправленный отчет по Лаб.3 на проверку

В **сопроводительном письме** ответьте на дополнительные вопросы из разделов "указания".

## Дополнительные файлы

Письмо должно содержать:
1. Ссылку на репозиторий с исходным кодом проекта с тестами
1. Имя ветки, в которой находится код (даже если это ветка по-умолчанию и называется `master`)
1. Путь до `settings.gradle` (`settings.kts`) файла соответствующего проекта от корня репозитория.

## Статистика (по желанию)
В отчете укажите примерное время решения каждой из предложенных задач, включая время ознакомления со справочными материалами (время решения не влияет на оценку: только на анонимный сбор статистики для корректировки сложности задач в будущем).


# Вспомогательные материалы
## Основные
1. https://developer.android.com/training/testing/espresso

## Дополнительные
1. https://developer.android.com/training/testing